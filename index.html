<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√în ki·ªÉm tra nghi·ªáp v·ª•</title>

    <!-- Caching directives for GitHub Pages -->
    <meta http-equiv="Cache-Control" content="max-age=86400">

    <!-- Preconnect to CDN resources -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- GoatCounter analytics -->
    <script data-goatcounter="https://uybinh3.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
    <!-- End GoatCounter analytics -->

    <!-- Confetti Library - Load asynchronously -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" async></script>
    <!-- End Confetti Library -->

    <style>
        * { /* Apply border-box universally */
            box-sizing: border-box;
        }
        /* --- COLOR VARIABLES --- */
        :root {
            /* Light Theme (Default) */
            --bg-color: #f8fafc; --text-color: #1f2937; --card-bg-color: #ffffff;
            --card-border-color: #e5e7eb; --primary-color: #4338ca; --secondary-color: #6b7280;
            --success-color: #16a34a; --danger-color: #dc2626; --warning-color: #d97706;
            --info-color: #0891b2; --timer-color: var(--primary-color); --disabled-bg-color: #f3f4f6;
            --disabled-text-color: #9ca3af; --button-default-bg: #ffffff; --button-default-text: var(--text-color);
            --button-default-border: var(--card-border-color); --button-hover-bg: #f3f4f6;
            --success-feedback-bg: #dcfce7; --success-feedback-text: #059669;
            --danger-feedback-bg: #fee2e2; --danger-feedback-text: #991b1b;
            --source-bg: #f3f4f6; --source-text: var(--secondary-color); --shadow-color: rgba(0, 0, 0, 0.05);
            --theme-toggle-icon: '‚òÄÔ∏è'; --settings-icon: '‚öôÔ∏è';
            --menu-bg: var(--card-bg-color); --menu-border: var(--card-border-color);
            --app-padding: 30px; --app-padding-mobile: 10px; /* This is now more of a general spacing unit */
            --timer-duration: 0.5s; /* Default CSS duration, JS overrides this */
            --filter-active-color: var(--danger-color); /* Color for active filter button */
            --grid-gap: 20px; /* General spacing unit */
            --card-padding: 25px;
            --navbar-height: 50px; /* Approximate height for potential use */
        }
        body.dark-theme {
             /* Dark Theme Overrides */
            --bg-color: #111827; --text-color: #f3f4f6; --card-bg-color: #1f2937;
            --card-border-color: #374151; --primary-color: #818cf8; --secondary-color: #9ca3af;
            --success-color: #86efac; --danger-color: #fda4af; --warning-color: #fcd34d;
            --info-color: #6ee7b7; --timer-color: var(--primary-color); --disabled-bg-color: #374151;
            --disabled-text-color: #9ca3af; --button-default-bg: #1f2937; --button-default-text: var(--text-color);
            --button-default-border: #374151; --button-hover-bg: #374151;
            --success-feedback-bg: #059669; --success-feedback-text: #ffffff;
            --danger-feedback-bg: #991b1b; --danger-feedback-text: #ffffff;
            --source-bg: #1f2937; --source-text: var(--secondary-color); --shadow-color: rgba(0, 0, 0, 0.1);
            --theme-toggle-icon: 'üåô'; --settings-icon: '‚öôÔ∏è';
            --menu-bg: #2a2a2a; --menu-border: #555555;
             --filter-active-color: var(--danger-color);
        }

        /* --- BASE STYLES --- */
         body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px; /* Padding for body, app has its own */
            min-height: 100vh;
            display: grid;
            place-items: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
         #app {
            display: flex;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            background-color: var(--card-bg-color);
            padding: var(--app-padding); /* Desktop padding for #app */
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow-color);
            border: 1px solid var(--card-border-color);
            transition: all 0.3s ease;
         }

         /* --- Top Navigation Bar --- */
         #top-navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: calc(var(--grid-gap) * 0.75); 
            margin-bottom: calc(var(--grid-gap) * 0.75); 
            border-bottom: 1px solid var(--card-border-color);
            width: 100%; 
         }
         .nav-left {
            display: flex;
            gap: 20px;
            align-items: center;
         }
         .nav-left a {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 500;
            font-size: 0.95em;
            padding: 5px 0;
            white-space: nowrap;
         }
         .nav-left a:hover, .nav-left a:focus {
            text-decoration: underline;
            color: var(--text-color);
         }
         #settings-btn { 
            background: none; border: none; font-size: 1.6em; cursor: pointer; padding: 0 5px; line-height: 1; color: var(--text-color);
            transition: opacity 0.2s ease;
         }
         #settings-btn:disabled { opacity: 0.5; cursor: not-allowed; }
         #settings-btn::after { content: var(--settings-icon); }


         .app-main-header { 
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.5em;
            margin-bottom: var(--grid-gap);
         }

         #usage-details, #select-section, #quiz-section, #results-section {
            margin-bottom: var(--grid-gap); 
         }
         #usage-details:last-child, #select-section:last-child, #quiz-section:last-child, #results-section:last-child {
             margin-bottom: 0;
         }


         @media (max-width: 768px) { /* Tablet and smaller */
            #app {
                padding-top: var(--app-padding-mobile); /* Keep top/bottom padding */
                padding-bottom: var(--app-padding-mobile);
                padding-left: 0; /* Remove side padding from #app itself */
                padding-right: 0;
                border-radius: 8px;
            }
            #top-navbar {
                padding-left: var(--app-padding-mobile); /* Navbar content gets side padding */
                padding-right: var(--app-padding-mobile);
                margin-bottom: var(--grid-gap);
                padding-bottom: var(--grid-gap);
            }
             .app-main-header {
                padding-left: var(--app-padding-mobile); /* Main header content gets side padding */
                padding-right: var(--app-padding-mobile);
            }

            .nav-left {
                gap: 12px;
            }
            .nav-left a {
                font-size: 0.9em;
            }
            #settings-btn {
                font-size: 1.5em;
            }
         }
         @media (max-width: 400px) { /* Small mobile */
            .nav-left {
                gap: 10px; /* Keep on one line, reduce gap */
            }
             /* .nav-left a white-space: nowrap is already set */
            #settings-btn {
                font-size: 1.4em; 
            }
         }


         h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.8em;
         }
         h2 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.4em;
         }
         #quiz-title { 
            font-size: 1.1em;
            color: var(--secondary-color);
            margin: 0;
            font-weight: normal;
            word-break: break-word;
         }

         /* --- HOW TO USE SECTION --- */
        #usage-details {
            text-align: left;
            border: 1px dashed var(--secondary-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            transition: all 0.3s ease-out;
            opacity: 1;
            max-height: 1000px;
            overflow: hidden;
        }
        #usage-details.hidden {
            opacity: 0;
            pointer-events: none;
            margin-bottom: 0;
            border: none;
            padding-top: 0;
            padding-bottom: 0;
            max-height: 0;
        }
        #usage-details summary {
            padding: 15px;
            font-weight: 600;
            cursor: pointer;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
        }
        #usage-details summary:hover {
            background-color: var(--button-hover-bg);
            color: var(--primary-color);
        }
        #usage-details div {
            padding: 15px;
            font-size: 0.9em;
            color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #usage-details code {
            background-color: var(--source-bg);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--text-color);
            font-size: 0.9em;
        }
        /* --- SELECT SECTION --- */
         #select-section {
            padding: 20px; 
            border: 1px solid var(--card-border-color); 
            border-radius: 8px;
            background-color: var(--bg-color); 
            text-align: left; 
            transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         #quiz-file-list {
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; min-height: 30px;
         }
         #quiz-file-select {
             width: 100%;
             padding: 10px 15px;
             font-size: 1em;
             border: 1px solid var(--card-border-color);
             border-radius: 5px;
             background-color: var(--button-default-bg);
             color: var(--text-color);
             cursor: pointer;
             transition: border-color 0.3s ease;
             margin-bottom: 15px;
             -webkit-appearance: none;
             -moz-appearance: none;
             appearance: none;
             background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
             background-repeat: no-repeat;
             background-position: right 10px center;
             background-size: 1em;
         }
         #quiz-file-select:hover {
             border-color: var(--primary-color);
         }
         #quiz-file-select:disabled {
             background-color: var(--disabled-bg-color);
             color: var(--disabled-text-color);
             cursor: not-allowed;
             opacity: 0.6;
         }
         #quiz-file-select option {
             padding: 10px;
             background-color: var(--button-default-bg);
             color: var(--text-color);
         }

         #status-message {
             display: none; margin-top: 5px; margin-bottom: 15px; color: var(--secondary-color); font-style: italic; min-height: 1.2em;
         }
         #status-message:not(:empty) {
             display: block;
         }
         #shuffle-option { margin-top: 15px; margin-bottom: 15px; }
         #shuffle-option label { margin-left: 8px; cursor: pointer; color: var(--secondary-color); font-weight: normal; }
         #shuffle-checkbox { vertical-align: middle; cursor: pointer; filter: invert(var(--is-dark, 0)); }
         body.dark-theme #shuffle-checkbox { --is-dark: 1; }

         /* --- QUIZ SECTION --- */
         #quiz-section { display: none; text-align: left; }

         #sticky-quiz-header-container {
            position: sticky;
            top: 0; 
            background-color: var(--card-bg-color); 
            z-index: 10;
            padding-top: var(--app-padding-mobile); /* Added to give more space at the top. Didn't use --app-padding because it quite big */
         }

         #auto-advance-timer-bar {
            height: 5px; background-color: var(--disabled-bg-color); border-radius: 0; overflow: hidden; display: none; transition: background-color 0.3s ease; --timer-duration: 0.5s;
         }
         #auto-advance-timer-bar::after { content: ""; display: block; height: 100%; width: 0%; background-color: var(--timer-color); border-radius: 0; animation: none; transition: background-color 0.3s ease; }
         #auto-advance-timer-bar.timer-active { display: block; }
         #auto-advance-timer-bar.timer-active::after { width: 100%; animation-name: countdown; animation-duration: var(--timer-duration); animation-timing-function: linear; animation-fill-mode: forwards; }
         @keyframes countdown { from { width: 100%; } to { width: 0%; } }
         
         #quiz-info-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px; 
            margin-bottom: 10px; 
            flex-wrap: wrap;
            gap: 10px; 
            padding: 0 var(--app-padding-mobile); /* Default padding for its content */
         }
         #progress { font-size: 0.9em; color: var(--secondary-color); font-weight: bold; flex-shrink: 0; }
         #jump-nav { display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
         #jump-nav label { color: var(--secondary-color); }
         #jump-to-input { width: 60px; padding: 4px 6px; border: 1px solid var(--card-border-color); border-radius: 4px; font-size: 0.95em; text-align: center; background-color: var(--button-default-bg); color: var(--text-color); }
         #jump-to-input::-webkit-outer-spin-button, #jump-to-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
         #jump-to-input[type=number] { -moz-appearance: textfield; }
         #jump-to-btn { padding: 4px 10px; font-size: 0.9em; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; }
         #jump-to-btn:hover { filter: brightness(1.1); }
         #score { font-size: 1.1em; font-weight: bold; color: var(--primary-color); flex-shrink: 0; }

        #nav-prev-next { 
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 10px var(--app-padding-mobile) 15px; /* Default padding for its content */
            border-bottom: 1px solid var(--card-border-color); 
        }

        #settings-dialog { 
            border: none; border-radius: 8px; box-shadow: 0 4px 12px var(--shadow-color); padding: 20px 30px;
            max-width: 350px; width: 90vw; background-color: var(--menu-bg); border: 1px solid var(--menu-border); color: var(--text-color);
            z-index: 1001; 
        }
        #settings-dialog::backdrop { background: rgba(0, 0, 0, 0.6); z-index: 1000;}
        #settings-dialog form { display: flex; flex-direction: column; gap: 15px; }
        #settings-dialog menu { display: flex; justify-content: flex-end; margin: 0; padding: 0; }
        #settings-dialog button[value="close"] { padding: 8px 16px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
        #settings-dialog button[value="close"]:hover { filter: brightness(1.1); }
        .settings-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .settings-item label { font-size: 0.95em; color: var(--text-color); margin-right: 10px; }
        .settings-item:last-child { margin-bottom: 0; }
        #timer-control { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--secondary-color); }
        #timer-control button { font-size: 1.1em; line-height: 1; padding: 2px 8px; min-width: 25px; cursor: pointer; border: 1px solid var(--button-default-border); background-color: var(--button-default-bg); color: var(--secondary-color); border-radius: 4px; transition: background-color 0.2s ease, border-color 0.2s ease; }
        #timer-control button:hover:not(:disabled) { background-color: var(--button-hover-bg); }
        #timer-control button:disabled { background-color: var(--disabled-bg-color); color: var(--disabled-text-color); cursor: not-allowed; opacity: 0.6;}
        #timer-duration-display { font-weight: bold; min-width: 35px; text-align: center; color: var(--text-color); }
        #theme-toggle-btn { background-color: var(--button-default-bg); border: 1px solid var(--button-default-border); font-size: 1.1em; color: var(--text-color); padding: 4px 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease; }
        #theme-toggle-btn:hover { background-color: var(--button-hover-bg); }
        #theme-toggle-btn::after { content: var(--theme-toggle-icon); margin-left: 5px; }

        #question-container {
             background-color: var(--bg-color); padding: 20px; border-radius: 8px;
             border: 1px solid var(--card-border-color); 
             /* margin-left/right removed as it will take padding from parent on mobile, or be centered on desktop */
             transition: background-color 0.3s ease, border-color 0.3s ease;
             margin-top: var(--grid-gap); 
         }
         #question-text { font-size: 1.4em; margin-bottom: 20px; color: var(--text-color); line-height: 1.4; white-space: pre-wrap; word-break: break-word;}
         #answers { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
         .answer-btn { display: block; width: 100%; padding: 12px 15px; background-color: var(--button-default-bg); border: 1px solid var(--button-default-border); border-radius: 5px; text-align: left; font-size: 1em; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; color: var(--text-color); white-space: pre-wrap; min-height: calc(1.6em + 24px); word-break: break-word;}
         .answer-btn:hover:not(:disabled) { background-color: var(--button-hover-bg); border-color: var(--secondary-color); }
         .answer-btn:disabled { cursor: not-allowed; background-color: var(--disabled-bg-color); color: var(--disabled-text-color); border-color: var(--card-border-color); opacity: 0.7; }
         .answer-btn.selected { border-width: 2px; font-weight: bold; }
         .answer-btn.correct { background-color: var(--success-color) !important; border-color: var(--success-color) !important; color: white !important; filter: brightness(0.9); }
         .answer-btn.incorrect { background-color: var(--danger-color) !important; border-color: var(--danger-color) !important; color: white !important; filter: brightness(0.9); }
         .answer-btn.reveal-correct { background-color: var(--success-feedback-bg) !important; border-color: var(--success-color) !important; color: var(--success-feedback-text) !important; font-weight: bold; }
         body.dark-theme .answer-btn.reveal-correct { background-color: #2ea043 !important; border-color: #56d364 !important; color: white !important; }
         #source { margin-top: 15px; padding: 10px; border-radius: 5px; font-size: 0.95em; min-height: 1.5em; /* margin-left/right removed */ background-color: var(--source-bg); color: var(--source-text); border: 1px solid var(--card-border-color); font-style: italic; display: none; white-space: pre-wrap; margin-bottom: 15px; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; word-break: break-word; }

         #quiz-controls-navigation { 
             display: flex;
             justify-content: center; 
             align-items: center;
             flex-wrap: wrap;
             gap: 10px;
             padding-top: var(--grid-gap); 
         }
         #nav-controls { display: flex; gap: 10px; flex-wrap: wrap; }
         #review-controls { display: flex; gap: 10px; flex-wrap: wrap;}
         #exit-review-btn { background-color: var(--warning-color); color: #212529; }
         body.dark-theme #exit-review-btn { color: #121212; }
         #toggle-filter-btn { background-color: var(--info-color); color: white; }
         #toggle-filter-btn.filter-active { background-color: var(--filter-active-color); font-weight: bold;}
         .nav-btn { padding: 10px 15px; font-size: 0.9em; border: none; border-radius: 5px; cursor: pointer; background-color: var(--secondary-color); color: white; transition: background-color 0.3s ease; white-space: nowrap; }
         .nav-btn:hover:not(:disabled) { filter: brightness(1.1); }
         .nav-btn:disabled { background-color: var(--disabled-bg-color); color: var(--disabled-text-color); cursor: not-allowed; opacity: 0.6; }
         #restart-practice-btn { background-color: var(--warning-color); color: #212529; }
         body.dark-theme #restart-practice-btn { color: #121212; }
         #restart-practice-btn:hover:not(:disabled) { filter: brightness(1.1); }
         #shuffle-now-btn { background-color: var(--info-color); color: white; }
         #shuffle-now-btn:hover:not(:disabled) { filter: brightness(1.1); }
         #reload-original-btn { background-color: var(--secondary-color); color: white; }
         #reload-original-btn:hover:not(:disabled) { filter: brightness(1.1); }
         #back-to-select-quiz-btn { background-color: var(--secondary-color); }
         #back-to-select-quiz-btn:hover:not(:disabled) { filter: brightness(1.1); }

         /* --- RESULTS SECTION --- */
         #results-section { display: none; text-align: left; padding: 30px var(--app-padding-mobile); background-color: var(--bg-color); border-radius: 8px; border: 1px solid var(--card-border-color); transition: background-color 0.3s ease, border-color 0.3s ease; }
         #final-score { font-size: 1.2em; margin-bottom: 20px; color: var(--text-color); font-weight: 500; }
         #results-controls { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; } 
         #restart-btn, #review-btn, #back-to-select-btn {
             padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease;
         }
         #restart-btn { background-color: var(--primary-color); color: white; }
         #review-btn { background-color: var(--success-color); color: white; }
         #back-to-select-btn { background-color: var(--secondary-color); color: white; }
         #restart-btn:hover, #review-btn:hover, #back-to-select-btn:hover { filter: brightness(1.1); }

         /* --- UTILITY CLASSES --- */
         #error-message { color: var(--danger-color); margin-top: 15px; font-weight: bold; /* padding: 0 var(--app-padding-mobile); /* Will inherit from parent section */ min-height: 1.2em; }
         .hidden { display: none !important; }

        /* --- Resume Confirmation Modal Styles --- */
        #resume-modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        #resume-modal-overlay:not(.hidden) {
            opacity: 1; visibility: visible;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }
        #resume-modal {
            background-color: var(--card-bg-color); padding: 25px 30px; border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-color); text-align: center;
            max-width: 90%; width: 400px; border: 1px solid var(--card-border-color);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
         #resume-modal-overlay:not(.hidden) #resume-modal { transform: scale(1); }
        #resume-modal h3 { color: var(--primary-color); margin-top: 0; margin-bottom: 15px; font-size: 1.4em; }
        #resume-modal p { color: var(--text-color); margin-bottom: 25px; font-size: 1em; line-height: 1.5; word-break: break-word; }
        #resume-modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .modal-btn {
            padding: 10px 20px; border-radius: 5px; border: none; font-size: 1em;
            cursor: pointer; transition: filter 0.2s ease, background-color 0.2s ease; min-width: 120px;
        }
        .modal-btn:hover { filter: brightness(1.1); }
         .modal-btn.primary { background-color: var(--primary-color); color: white; }
          body.dark-theme .modal-btn.primary { color: #121212; }
          body.dark-theme .modal-btn.primary:hover { color: #121212; }
         .modal-btn.secondary { background-color: var(--secondary-color); color: white; }
         body.dark-theme .modal-btn.secondary { background-color: var(--secondary-color); color: white; }

         /* --- RESPONSIVE DESIGN (further adjustments for mobile) --- */
         @media (max-width: 700px) {
             body { padding: 0; } 
             #app {
                 /* padding-top, padding-bottom already set from 768px breakpoint */
                 /* padding-left: 0, padding-right: 0 already set from 768px breakpoint */
                 box-shadow: none; border-radius: 0; max-width: 100%; border: none;
             }
            
             #usage-details, 
             #select-section, 
             #results-section,
             #quiz-section { /* Quiz section itself also needs this treatment for its background */
                border-radius: 0;
                border-left: none;
                border-right: none;
                /* margin-left: 0; /* Covered by #app's lack of padding */
                /* margin-right: 0; /* Covered by #app's lack of padding */
                padding-left: var(--app-padding-mobile); 
                padding-right: var(--app-padding-mobile);
             }
             /* For quiz-section, its children like question-container might need margin adjustment if they were expecting parent padding */
             #sticky-quiz-header-container {
                margin-right: calc(-1 * var(--app-padding-mobile));
                padding-left: var(--app-padding-mobile); /* Then re-apply padding for content */
                padding-right: var(--app-padding-mobile);
                padding-top: var(--app-padding-mobile); /* Added to give more space at the top */
                top: 0;  
             }
              #quiz-info-header, #nav-prev-next { /* Children of sticky header */
                 padding-left: 0; /* Content padding now managed by sticky-quiz-header-container */
                 padding-right: 0;
              }
              #quiz-info-header { margin-top: 5px; }
              #nav-prev-next { padding-top: 5px; padding-bottom: 10px; border-bottom-width: 1px; }


             h1 { font-size: 1.6em; } h2 { font-size: 1.4em; }
             #quiz-title { font-size: 1em; margin-bottom: 1em; }


             #question-container { 
                 padding: 15px var(--app-padding-mobile); 
                 margin-left: 0; /* Align with parent #quiz-section padding */
                 margin-right: 0;
                 margin-top: var(--grid-gap); /* Space from sticky header */
                 margin-bottom: 15px; 
                 border-radius: 0; border-left: none; border-right: none; 
             }
             #source { 
                 margin-left: 0; /* Align with parent #quiz-section padding */
                 margin-right: 0;
                 margin-bottom: 15px; 
                 padding-left: var(--app-padding-mobile); padding-right: var(--app-padding-mobile); 
                 border-radius: 0; border-left: none; border-right: none; 
            }

             #quiz-controls-navigation {
                 padding-left: 0; /* Content padding now managed by parent #quiz-section */
                 padding-right: 0;
                 padding-bottom: var(--app-padding-mobile); /* Add bottom padding for mobile */
                 justify-content: center; 
                 flex-direction: row; 
             }

             #question-text { font-size: 1.1em; }
             .answer-btn {
                 font-size: 1.05em;
                 padding: 16px 18px;
                 margin-bottom: 5px;
                 min-height: 3em;
             }
             .nav-btn { font-size: 0.85em; padding: 8px 12px; }
             #settings-dialog { padding: 15px 20px; } 
             #results-controls { flex-direction: column; gap: 10px; align-items: center; }
             #restart-btn, #review-btn, #back-to-select-btn { width: 80%; max-width: 300px; }
             #resume-modal { width: 90%; padding: 20px; }
             #resume-modal h3 { font-size: 1.2em; } #resume-modal p { font-size: 0.95em; }
             .modal-btn { font-size: 0.9em; padding: 8px 15px; min-width: 100px; }
         }


        /* --- Touch Swipe Support --- */
        #question-container {
            touch-action: pan-y;
            position: relative;
        }
        .swipe-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--card-bg-color);
            color: var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 10px var(--shadow-color);
            pointer-events: none;
            z-index: 100;
        }
        .swipe-left { left: 15px; }
        .swipe-right { right: 15px; }
        .swipe-active { opacity: 0.9; }

    </style>
</head>
<body class=""> <!-- Theme class managed by JS -->
    <div id="app">
        <nav id="top-navbar">
            <div class="nav-left">
                <a href="#" id="nav-home-link">Trang ch·ªß</a>
                <a href="#" id="nav-about-link">Gi·ªõi thi·ªáu</a> <!-- Placeholder for now -->
            </div>
            <div class="nav-right">
                <button id="settings-btn" title="C√†i ƒë·∫∑t"></button> <!-- Moved here -->
            </div>
        </nav>

        <div class="app-main-header"> 
            <h1>√în ki·ªÉm tra nghi·ªáp v·ª•</h1>
            <h2>ƒê·ª£t 1 - 2025</h2>
            <h2 id="quiz-title" class="hidden"></h2> 
        </div>


        <details id="usage-details" open>
             <summary>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</summary>
             <div>
                 <ol>
                     <li>Ch·ªçn m·ªôt b·ªô c√¢u h·ªèi t·ª´ danh s√°ch b√™n d∆∞·ªõi.</li>
                     <li>(T√πy ch·ªçn) Tick "X√°o tr·ªôn" <i>tr∆∞·ªõc khi</i> ch·ªçn b·ªô c√¢u h·ªèi ƒë·ªÉ c√¢u h·ªèi hi·ªán ng·∫´u nhi√™n.</li>
                     <li>Quiz s·∫Ω b·∫Øt ƒë·∫ßu sau khi d·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i.</li>
                     <li>Tr·∫£ l·ªùi b·∫±ng c√°ch nh·∫•n v√†o ƒë√°p √°n.</li>
                     <li>S·ª≠ d·ª•ng n√∫t "C√¢u tr∆∞·ªõc", "C√¢u sau", ho·∫∑c nh·∫≠p s·ªë c√¢u v√†o √¥ "ƒê·∫øn:" ƒë·ªÉ di chuy·ªÉn.</li>
                     <li>Nh·∫•n bi·ªÉu t∆∞·ª£ng ‚öôÔ∏è ƒë·ªÉ ch·ªânh t·ªëc ƒë·ªô t·ª± chuy·ªÉn c√¢u ho·∫∑c ƒë·ªïi giao di·ªán S√°ng/T·ªëi.</li>
                     <li>Khi ho√†n th√†nh, xem k·∫øt qu·∫£ v√† c√≥ th·ªÉ l√†m l·∫°i (b·ªô c√¢u h·ªèi hi·ªán t·∫°i), xem l·∫°i b√†i l√†m, ho·∫∑c quay l·∫°i ch·ªçn b·ªô c√¢u h·ªèi kh√°c.</li>
                 </ol>
             </div>
        </details>

        <div id="select-section">
             <h2>Ch·ªçn B·ªô C√¢u H·ªèi</h2>
             <div id="quiz-file-list">
                 <select id="quiz-file-select">
                     <option value="">ƒêang t·∫£i danh s√°ch b·ªô c√¢u h·ªèi...</option>
                 </select>
             </div>
             <p id="status-message"></p>
             <div id="shuffle-option">
                 <input type="checkbox" id="shuffle-checkbox">
                 <label for="shuffle-checkbox">X√°o tr·ªôn c√¢u h·ªèi</label>
             </div>
             <p id="error-message" class="hidden"></p>
        </div>

        <div id="quiz-section" class="hidden">
            <div id="sticky-quiz-header-container">
                <div id="auto-advance-timer-bar"></div>
                <div id="quiz-info-header"> 
                     <div id="progress">C√¢u 1 / 10</div>
                     <div id="jump-nav">
                         <label for="jump-to-input" id="jump-label">ƒê·∫øn:</label>
                         <input type="number" id="jump-to-input" min="1">
                         <button id="jump-to-btn">ƒêi</button>
                     </div>
                     <div id="score">ƒêi·ªÉm: 0</div>
                </div>
                <div id="nav-prev-next"> 
                    <button id="prev-btn" class="nav-btn">C√¢u tr∆∞·ªõc</button>
                    <button id="next-btn" class="nav-btn">C√¢u sau</button>
                </div>
            </div>
            
            <dialog id="settings-dialog">
                <form method="dialog">
                    <div class="settings-item">
                        <label for="timer-control">T·ª± chuy·ªÉn (gi√¢y):</label>
                        <div id="timer-control">
                            <button id="timer-decrease-btn" type="button" title="Gi·∫£m">-</button>
                            <span id="timer-duration-display">0.5s</span>
                            <button id="timer-increase-btn" type="button" title="TƒÉng">+</button>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label for="theme-toggle-btn">Giao di·ªán:</label>
                        <button id="theme-toggle-btn" type="button"></button>
                    </div>
                    <menu>
                        <button value="close">ƒê√≥ng</button>
                    </menu>
                </form>
            </dialog>

            <div id="question-container">
                <h2 id="question-text">...</h2>
                <div id="answers"></div>
            </div>

            <div id="source" class="hidden">...</div>

            <div id="quiz-controls-navigation" class="quiz-navigation"> 
                <div id="nav-controls" class="hidden">
                    <button id="restart-practice-btn" class="nav-btn">L√†m l·∫°i</button>
                    <button id="shuffle-now-btn" class="nav-btn">X√°o tr·ªôn</button>
                    <button id="reload-original-btn" class="nav-btn">Th·ª© t·ª± g·ªëc</button>
                    <button id="back-to-select-quiz-btn" class="nav-btn">Ch·ªçn b·ªô kh√°c</button>
                </div>
                <div id="review-controls" class="hidden">
                    <button id="exit-review-btn" class="nav-btn">Tho√°t xem l·∫°i</button>
                    <button id="toggle-filter-btn" class="nav-btn">Ch·ªâ xem c√¢u sai</button>
                </div>
            </div>
        </div> 

        <div id="results-section" class="hidden">
             <h2>K·∫øt qu·∫£ Quiz</h2>
             <p id="final-score">ƒêi·ªÉm s·ªë cu·ªëi c√πng: 0 / 0</p>
             <div id="results-controls">
                <button id="restart-btn">L√†m l·∫°i Quiz (B·ªô n√†y)</button>
                <button id="review-btn">Xem l·∫°i b√†i l√†m</button>
                <button id="back-to-select-btn">Ch·ªçn b·ªô c√¢u h·ªèi kh√°c</button>
            </div>
        </div>

        <div id="resume-modal-overlay" class="hidden">
            <div id="resume-modal">
                <h3 id="resume-modal-title">Ti·∫øp t·ª•c phi√™n l√†m vi·ªác?</h3>
                <p id="resume-modal-text">B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c b√†i l√†m d·ªü dang?</p>
                <div id="resume-modal-buttons">
                    <button id="resume-btn-yes" class="modal-btn primary">Ti·∫øp t·ª•c</button>
                    <button id="resume-btn-no" class="modal-btn secondary">B·∫Øt ƒë·∫ßu m·ªõi</button>
                </div>
            </div>
        </div>
    </div> 

    <script>
        // --- DOM Element References ---
        const bodyElement = document.body;
        const quizTitleElement = document.getElementById('quiz-title');
        const usageDetails = document.getElementById('usage-details');
        const selectSection = document.getElementById('select-section');
        const quizFileListContainer = document.getElementById('quiz-file-list');
        let quizFileSelect = document.getElementById('quiz-file-select'); // This will be updated
        const statusMessage = document.getElementById('status-message');
        const shuffleCheckbox = document.getElementById('shuffle-checkbox');
        const quizSection = document.getElementById('quiz-section');
        const resultsSection = document.getElementById('results-section');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers');
        const sourceDiv = document.getElementById('source');
        const timerBar = document.getElementById('auto-advance-timer-bar');
        const progressText = document.getElementById('progress');
        const scoreText = document.getElementById('score');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const navControls = document.getElementById('nav-controls'); 
        const reviewControls = document.getElementById('review-controls'); 
        const restartPracticeBtn = document.getElementById('restart-practice-btn');
        const shuffleNowBtn = document.getElementById('shuffle-now-btn');
        const reloadOriginalBtn = document.getElementById('reload-original-btn');
        const backToSelectQuizBtn = document.getElementById('back-to-select-quiz-btn');
        const exitReviewBtn = document.getElementById('exit-review-btn');
        const toggleFilterBtn = document.getElementById('toggle-filter-btn');
        const finalScoreText = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-btn');
        const reviewBtn = document.getElementById('review-btn');
        const backToSelectBtn = document.getElementById('back-to-select-btn');
        const errorMessage = document.getElementById('error-message');
        const jumpNav = document.getElementById('jump-nav');
        const jumpLabel = document.getElementById('jump-label');
        const jumpToInput = document.getElementById('jump-to-input');
        const jumpToBtn = document.getElementById('jump-to-btn');
        const timerDecreaseBtn = document.getElementById('timer-decrease-btn');
        const timerIncreaseBtn = document.getElementById('timer-increase-btn');
        const timerDurationDisplay = document.getElementById('timer-duration-display');
        const settingsBtn = document.getElementById('settings-btn');
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const resumeModalOverlay = document.getElementById('resume-modal-overlay');
        const resumeModalText = document.getElementById('resume-modal-text');
        const resumeBtnYes = document.getElementById('resume-btn-yes');
        const resumeBtnNo = document.getElementById('resume-btn-no');
        const navPrevNextContainer = document.getElementById('nav-prev-next'); 
        const bottomNavigationContainer = document.getElementById('quiz-controls-navigation'); // ID Updated
        const navHomeLink = document.getElementById('nav-home-link');
        const navAboutLink = document.getElementById('nav-about-link');


        // --- Quiz State Variables ---
        let originalQuizData = []; let quizData = []; let currentQuestionIndex = 0;
        let score = 0; let userAnswers = {}; let questionsAnswered = {};
        let autoAdvanceTimer = null; let autoAdvanceDuration = 500;
        const TIMER_STEP = 100; const MIN_TIMER = 500; const MAX_TIMER = 5000;
        let isReviewMode = false; let reviewWrongOnly = false;
        let wrongAnswerIndices = []; let currentWrongAnswerReviewIndex = 0;
        let currentQuizDisplayName = ""; 
        const MANIFEST_PATH = 'data/quiz_manifest.json';
        let loadedQuizzes = {}; 

        // --- State Persistence ---
        const STORAGE_KEY = 'quizAppState';

        function saveState() {
            let currentView = 'select';
             if (quizSection.classList.contains('hidden') === false) { currentView = 'quiz'; }
             else if (resultsSection.classList.contains('hidden') === false) { currentView = 'results'; }
             else if (selectSection.classList.contains('hidden') === false) { currentView = 'select'; }

            if (currentView === 'select') {
                if (localStorage.getItem(STORAGE_KEY)) { clearState(); } 
                return;
            }

            const state = { 
                view: currentView, 
                quizDisplayName: currentQuizDisplayName, 
                originalQuizData: originalQuizData, 
                quizData: quizData, 
                currentQuestionIndex: currentQuestionIndex, 
                userAnswers: userAnswers, 
                questionsAnswered: questionsAnswered, 
                score: score, 
                isReviewMode: isReviewMode, 
                reviewWrongOnly: reviewWrongOnly, 
                wrongAnswerIndices: wrongAnswerIndices, 
                currentWrongAnswerReviewIndex: currentWrongAnswerReviewIndex, 
                autoAdvanceDuration: autoAdvanceDuration, 
                shuffleChecked: shuffleCheckbox.checked 
            };
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); console.log("[State] Saved state:", currentView, "Quiz:", currentQuizDisplayName || 'N/A', "Q:", (currentQuestionIndex + 1) || '?'); }
            catch (e) { console.error("[State] Error saving state:", e); }
        }

        function loadState() {
            try {
                const savedStateJSON = localStorage.getItem(STORAGE_KEY);
                if (!savedStateJSON) return null;
                const savedState = JSON.parse(savedStateJSON);
                if (!savedState || typeof savedState.view !== 'string' || typeof savedState.quizDisplayName !== 'string' || !Array.isArray(savedState.quizData) || typeof savedState.currentQuestionIndex !== 'number' || typeof savedState.userAnswers !== 'object') {
                    console.warn("[State] Invalid saved state structure, clearing."); clearState(); return null;
                }
                if (savedState.view === 'select') { clearState(); return null; } 

                currentQuizDisplayName = savedState.quizDisplayName || "";
                originalQuizData = savedState.originalQuizData || [];
                quizData = savedState.quizData || [];
                currentQuestionIndex = savedState.currentQuestionIndex || 0;
                userAnswers = savedState.userAnswers || {};
                questionsAnswered = savedState.questionsAnswered || {};
                score = savedState.score || 0;
                isReviewMode = savedState.isReviewMode || false;
                reviewWrongOnly = savedState.reviewWrongOnly || false;
                wrongAnswerIndices = savedState.wrongAnswerIndices || [];
                currentWrongAnswerReviewIndex = savedState.currentWrongAnswerReviewIndex || 0;
                autoAdvanceDuration = savedState.autoAdvanceDuration || 500;
                shuffleCheckbox.checked = savedState.shuffleChecked || false;

                if (quizData.length === 0 && savedState.view !== 'select') { console.warn("[State] Restored quizData empty, clearing."); clearState(); return null; }
                if (currentQuestionIndex >= quizData.length) { console.warn("[State] Restored index out of bounds, resetting."); currentQuestionIndex = 0; }

                console.log("[State] Found valid saved state:", savedState.view);
                return savedState;
            } catch (e) { console.error("[State] Error loading state:", e); clearState(); return null; }
        }

        function clearState() {
            try { localStorage.removeItem(STORAGE_KEY); console.log("[State] Cleared saved state."); }
            catch (e) { console.error("[State] Error clearing state:", e); }
        }
        
         function showResumeModal(message) {
             resumeModalText.textContent = message; 
             resumeModalOverlay.classList.remove('hidden');
         }
         function hideResumeModal() {
             resumeModalOverlay.classList.add('hidden');
         }
         
        function applyInitialTheme() { const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark') { bodyElement.classList.add('dark-theme'); } else { bodyElement.classList.remove('dark-theme'); } updateThemeToggleButton(); }
        function toggleTheme() { bodyElement.classList.toggle('dark-theme'); const isDark = bodyElement.classList.contains('dark-theme'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); updateThemeToggleButton(); }
        function updateThemeToggleButton() { /* Icon handled by CSS */ }

        function toggleSettingsMenu() {
            const settingsDialog = document.getElementById('settings-dialog');
            if (settingsDialog.open) { settingsDialog.close(); } else { settingsDialog.showModal(); }
        }

        // --- Event Listener Helper ---
        function attachQuizSelectListener() {
            quizFileSelect = document.getElementById('quiz-file-select'); // Ensure we have the latest instance
            if (quizFileSelect) {
                // Clone and replace to ensure no old listeners are carried over
                const newSelect = quizFileSelect.cloneNode(true); // true to clone children (options)
                if (quizFileSelect.parentNode) {
                    quizFileSelect.parentNode.replaceChild(newSelect, quizFileSelect);
                }
                quizFileSelect = newSelect; // Work with the new, clean select element

                console.log("[Events] Attaching 'change' listener to quizFileSelect:", quizFileSelect.id);
                quizFileSelect.addEventListener('change', function handleQuizSelectionChange() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        console.log(`[Event] Quiz selected: DisplayName="${selectedOption.dataset.quizDisplayName}", FilePath="${selectedOption.value}"`);
                        loadQuizFromJson(selectedOption.value, selectedOption.dataset.quizDisplayName);
                    } else {
                        console.log("[Event] Quiz selection cleared or invalid (no value).");
                    }
                });
            } else {
                console.error("[Events] quizFileSelect element not found for attaching listener.");
            }
        }


        // --- Event Listeners (for other buttons) ---
        prevBtn.addEventListener('click', navigatePrevious); 
        nextBtn.addEventListener('click', navigateNext); 
        restartPracticeBtn.addEventListener('click', restartQuiz);
        shuffleNowBtn.addEventListener('click', handleShuffleNow);
        reloadOriginalBtn.addEventListener('click', handleReloadOriginal);
        backToSelectQuizBtn.addEventListener('click', showSelectScreen);
        exitReviewBtn.addEventListener('click', exitReviewMode);
        toggleFilterBtn.addEventListener('click', toggleReviewFilter);
        restartBtn.addEventListener('click', restartQuiz); 
        reviewBtn.addEventListener('click', startReviewMode); 
        backToSelectBtn.addEventListener('click', showSelectScreen); 
        jumpToBtn.addEventListener('click', handleJumpToQuestion);
        jumpToInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); handleJumpToQuestion(); } });
        answersContainer.addEventListener('click', (event) => { if (event.target.classList.contains('answer-btn') && !event.target.disabled) { handleAnswerSelection(event.target); } });
        timerDecreaseBtn.addEventListener('click', decreaseTimer);
        timerIncreaseBtn.addEventListener('click', increaseTimer);
        settingsBtn.addEventListener('click', toggleSettingsMenu);
        themeToggleButton.addEventListener('click', toggleTheme);
        resumeBtnYes.addEventListener('click', handleResumeYes);
        resumeBtnNo.addEventListener('click', handleResumeNo);
        if (navHomeLink) {
            navHomeLink.addEventListener('click', (e) => {
                e.preventDefault();
                showSelectScreen(false); // Go to home, clear state
            });
        }
        if (navAboutLink) {
            navAboutLink.addEventListener('click', (e) => {
                e.preventDefault();
                // Placeholder for About page functionality
                alert('Trang "Gi·ªõi thi·ªáu" ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng.');
            });
        }


        function handleResumeYes() {
            console.log("[Init] User chose YES (Resume).");
            hideResumeModal();
            restoreSavedSession(); 
        }

        function handleResumeNo() {
            console.log("[Init] User chose NO (Start Fresh).");
            hideResumeModal();
            clearState(); 
            updateTimerDisplayAndControls(); 
            showSelectScreen(true); 
            if (usageDetails.hasAttribute('open')) { usageDetails.open = true; usageDetails.classList.remove('hidden'); }
            else { usageDetails.classList.add('hidden'); }
        }

        function restoreSavedSession() {
             console.log(`[Init] Restoring saved session for "${currentQuizDisplayName}"...`);
             updateTimerDisplayAndControls(); 
             quizTitleElement.textContent = currentQuizDisplayName; 
             quizTitleElement.classList.remove('hidden');

             selectSection.classList.add('hidden'); selectSection.style.display = 'none';
             quizSection.classList.add('hidden'); quizSection.style.display = 'none';
             resultsSection.classList.add('hidden'); resultsSection.style.display = 'none';
             usageDetails.classList.add('hidden'); 

             const viewToRestore = localStorage.getItem(STORAGE_KEY) ? JSON.parse(localStorage.getItem(STORAGE_KEY)).view : null;
             
             settingsBtn.disabled = false; 

             if (viewToRestore === 'quiz') {
                 quizSection.classList.remove('hidden'); quizSection.style.display = 'block'; 
                 navControls.classList.toggle('hidden', isReviewMode); 
                 reviewControls.classList.toggle('hidden', !isReviewMode); 
                 settingsBtn.disabled = isReviewMode;
                 settingsBtn.style.opacity = isReviewMode ? '0.5' : '';
                 settingsBtn.style.cursor = isReviewMode ? 'not-allowed' : '';
                 jumpToInput.max = (quizData && quizData.length > 0) ? quizData.length : 1;
                 displayQuestion(currentQuestionIndex);
             } else if (viewToRestore === 'results') {
                 resultsSection.classList.remove('hidden'); resultsSection.style.display = 'block';
                 settingsBtn.disabled = true; 
                 showResults(); 
             } else {
                  console.warn("[Restore Error] Could not determine view, starting fresh.");
                  handleResumeNo(); 
             }
        }

        function decreaseTimer() { if (!isReviewMode && autoAdvanceDuration > MIN_TIMER) { autoAdvanceDuration -= TIMER_STEP; updateTimerDisplayAndControls(); saveState(); } }
        function increaseTimer() { if (!isReviewMode && autoAdvanceDuration < MAX_TIMER) { autoAdvanceDuration += TIMER_STEP; updateTimerDisplayAndControls(); saveState(); } }
        function updateTimerDisplayAndControls() { timerDurationDisplay.textContent = (autoAdvanceDuration / 1000).toFixed(1) + 's'; timerDecreaseBtn.disabled = isReviewMode || autoAdvanceDuration <= MIN_TIMER; timerIncreaseBtn.disabled = isReviewMode || autoAdvanceDuration >= MAX_TIMER; timerBar.style.setProperty('--timer-duration', autoAdvanceDuration + 'ms'); }
        function clearAutoAdvanceTimer() { if (autoAdvanceTimer) { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = null; } timerBar.classList.remove('timer-active'); timerBar.style.animation = 'none'; void timerBar.offsetWidth; timerBar.style.animation = null; }
        function navigatePrevious() { clearAutoAdvanceTimer(); let changed = false; if (reviewWrongOnly) { if (currentWrongAnswerReviewIndex > 0) { currentWrongAnswerReviewIndex--; currentQuestionIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex]; changed = true; } } else { if (currentQuestionIndex > 0) { currentQuestionIndex--; changed = true; } } if (changed) { displayQuestion(currentQuestionIndex); saveState(); } }
        function navigateNext() { clearAutoAdvanceTimer(); let changed = false; let finished = false; if (reviewWrongOnly) { if (currentWrongAnswerReviewIndex < wrongAnswerIndices.length - 1) { currentWrongAnswerReviewIndex++; currentQuestionIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex]; changed = true; } } else { if (currentQuestionIndex < quizData.length - 1) { currentQuestionIndex++; changed = true; } else if (!isReviewMode) { finished = true; } } if (changed) { displayQuestion(currentQuestionIndex); saveState(); } else if (finished) { showResults(); } }
        function handleJumpToQuestion() { if (!quizData || quizData.length === 0) return; const targetNum = parseInt(jumpToInput.value, 10); let maxQuestions, targetIndex = -1; let changed = false; if (reviewWrongOnly) { maxQuestions = wrongAnswerIndices.length; if (!isNaN(targetNum) && targetNum >= 1 && targetNum <= maxQuestions) { currentWrongAnswerReviewIndex = targetNum - 1; targetIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex]; if (targetIndex !== currentQuestionIndex) changed = true; } else { alert(`Vui l√≤ng nh·∫≠p s·ªë th·ª© t·ª± c√¢u sai h·ª£p l·ªá t·ª´ 1 ƒë·∫øn ${maxQuestions}.`); } } else { maxQuestions = quizData.length; if (!isNaN(targetNum) && targetNum >= 1 && targetNum <= maxQuestions) { targetIndex = targetNum - 1; if (targetIndex !== currentQuestionIndex) changed = true; } else { alert(`Vui l√≤ng nh·∫≠p s·ªë c√¢u h·ª£p l·ªá t·ª´ 1 ƒë·∫øn ${maxQuestions}.`); } } if (changed) { clearAutoAdvanceTimer(); currentQuestionIndex = targetIndex; displayQuestion(currentQuestionIndex); saveState(); } jumpToInput.value = ''; }
        function handleShuffleNow() { if (isReviewMode || !quizData || quizData.length === 0) return; console.log("[Action] Shuffling current questions..."); shuffleArray(quizData); restartQuiz(true); }
        function handleReloadOriginal() { if (isReviewMode || !originalQuizData || originalQuizData.length === 0) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu g·ªëc ƒë·ªÉ t·∫£i l·∫°i."); return; } console.log("[Action] Reloading original question order..."); quizData = [...originalQuizData]; restartQuiz(); }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

        function loadQuizManifest() {
            console.log(`[Manifest] Starting to fetch ${MANIFEST_PATH}...`);
            hideError();
            quizFileSelect = document.getElementById('quiz-file-select'); // Ensure we have the current instance
            if (!quizFileSelect) { console.error("[Manifest Error] Quiz file select element not found"); showError("L·ªói: Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ ch·ªçn c√¢u h·ªèi"); return; }
            quizFileSelect.innerHTML = '<option value="">ƒêang t·∫£i danh s√°ch...</option>'; quizFileSelect.disabled = true; statusMessage.textContent = ""; shuffleCheckbox.disabled = true;
            const cachedManifest = sessionStorage.getItem('quizManifest');
            if (cachedManifest) {
                try { 
                    const manifestData = JSON.parse(cachedManifest); 
                    console.log("[Manifest] Using cached manifest data"); 
                    displayQuizOptions(manifestData);
                    attachQuizSelectListener(); 
                    return; 
                }
                catch (e) { console.warn("[Manifest] Failed to parse cached manifest:", e); }
            }
            const cacheBuster = location.hostname === 'localhost' || location.hostname === '127.0.0.1' ? `?t=${new Date().getTime()}` : '';
            fetch(MANIFEST_PATH + cacheBuster)
                .then(response => { if (!response.ok) throw new Error(`L·ªói m·∫°ng ${response.status}`); return response.json(); })
                .then(quizList => {
                    console.log("[Manifest] Successfully loaded quiz list:", quizList); if (!Array.isArray(quizList)) throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá: Danh s√°ch kh√¥ng ph·∫£i m·∫£ng");
                    sessionStorage.setItem('quizManifest', JSON.stringify(quizList)); 
                    displayQuizOptions(quizList);
                    attachQuizSelectListener(); 
                })
                .catch(error => { 
                    console.error("[Manifest Error]", error); 
                    showError(`Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch: ${error.message}`); 
                    if (quizFileSelect) {
                        quizFileSelect.innerHTML = '<option value="">L·ªói t·∫£i danh s√°ch</option>'; 
                    }
                    statusMessage.textContent = "L·ªói."; 
                });
        }

        function displayQuizOptions(quizList) {
            console.log("[UI] Starting to display options...");
            hideError();
            quizFileSelect = document.getElementById('quiz-file-select'); 
            if (!quizFileSelect) { console.error("[UI Error] Quiz file select element not found for displayQuizOptions"); showError("L·ªói hi·ªÉn th·ªã danh s√°ch c√¢u h·ªèi"); return; }
            
            quizFileSelect.innerHTML = ''; 
            const defaultOption = document.createElement('option'); 
            defaultOption.value = ""; 
            defaultOption.textContent = "Vui l√≤ng ch·ªçn b·ªô c√¢u h·ªèi"; 
            quizFileSelect.appendChild(defaultOption);
            
            if (quizList && Array.isArray(quizList) && quizList.length > 0) {
                quizList.forEach((quiz) => {
                    if (quiz && typeof quiz.name === 'string' && typeof quiz.file === 'string') {
                        const option = document.createElement('option'); 
                        option.value = quiz.file; 
                        option.textContent = quiz.name; 
                        option.dataset.quizDisplayName = quiz.name; 
                        quizFileSelect.appendChild(option); 
                    } else { console.warn("[UI] Skipping invalid quiz item:", quiz); }
                });
            }
            quizFileSelect.disabled = false; 
            shuffleCheckbox.disabled = false;
            if (!quizList || quizList.length === 0) { statusMessage.textContent = "Kh√¥ng t√¨m th·∫•y b·ªô c√¢u h·ªèi n√†o."; statusMessage.style.display = "block"; }
            else { statusMessage.textContent = ""; statusMessage.style.display = "none"; }
        }

        function loadQuizFromJson(jsonFilePath, quizDisplayName) {
            console.log(`[Fetch] Requesting "${quizDisplayName}" from ${jsonFilePath}`);
            hideError(); statusMessage.textContent = `ƒêang t·∫£i "${quizDisplayName}"...`;
            quizFileSelect = document.getElementById('quiz-file-select'); 
            if (quizFileSelect) { quizFileSelect.disabled = true; } 
            shuffleCheckbox.disabled = true;

            currentQuizDisplayName = quizDisplayName; 
            quizTitleElement.textContent = quizDisplayName; 
            quizTitleElement.classList.remove('hidden');

            if (loadedQuizzes[jsonFilePath]) { console.log("[Fetch] Using cached quiz data for", jsonFilePath); processQuizData(loadedQuizzes[jsonFilePath]); return; }

            const cacheBuster = location.hostname === 'localhost' || location.hostname === '127.0.0.1' ? `?t=${new Date().getTime()}` : '';
            fetch(jsonFilePath + cacheBuster)
                .then(response => { if (!response.ok) throw new Error(`L·ªói m·∫°ng ${response.status} khi t·∫£i ${jsonFilePath}`); return response.json(); })
                .then(jsonData => { 
                    console.log("[Fetch] Success for", jsonFilePath, jsonData); 
                    loadedQuizzes[jsonFilePath] = jsonData; 
                    processQuizData(jsonData); 
                })
                .catch(error => { 
                    console.error("[Fetch Error] for " + jsonFilePath, error); 
                    showError(`L·ªói t·∫£i "${quizDisplayName}": ${error.message}`); 
                    showSelectScreen(); 
                });
        }

        function processQuizData(jsonData) { 
             console.log(`[Processing] Data for "${jsonData.originalDisplayName || currentQuizDisplayName}". Questions:`, jsonData.questions ? jsonData.questions.length : 'N/A');
             try {
                 if (!jsonData || !Array.isArray(jsonData.questions) || jsonData.questions.length === 0) {
                     throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ c√¢u h·ªèi. Received: " + JSON.stringify(jsonData).substring(0, 100));
                 }
                 const firstQ = jsonData.questions[0]; 
                 if (typeof firstQ.question !== 'string' || !Array.isArray(firstQ.options) || typeof firstQ.correctAnswerIndex !== 'number') {
                     console.warn("[Processing] C·∫•u tr√∫c c√¢u h·ªèi ƒë·∫ßu ti√™n c√≥ v·∫ª l·∫°:", firstQ);
                 }

                 originalQuizData = [...jsonData.questions]; 
                 quizData = [...jsonData.questions];

                 if (shuffleCheckbox.checked) { console.log("[Prep] Shuffling..."); shuffleArray(quizData); }
                 
                 statusMessage.textContent = `ƒê√£ t·∫£i: ${currentQuizDisplayName} (${quizData.length} c√¢u)`;
                 usageDetails.classList.add('hidden'); 
                 selectSection.classList.add('hidden'); selectSection.style.display = 'none';
                 startQuiz(); 
                 saveState(); 

             } catch (error) { 
                 console.error("[Processing Error]", error); 
                 showError(`L·ªói x·ª≠ l√Ω d·ªØ li·ªáu: ${error.message}.`); 
                 showSelectScreen(); 
            }
         }

        function startQuiz(wasShuffledOrRestarted = false) {
            console.log("[Mode] Starting Quiz. Display Name:", currentQuizDisplayName);
             if (wasShuffledOrRestarted) {
                 currentQuestionIndex = 0; score = 0; userAnswers = {}; questionsAnswered = {}; isReviewMode = false; reviewWrongOnly = false; wrongAnswerIndices = []; currentWrongAnswerReviewIndex = 0;
             }
            clearAutoAdvanceTimer(); hideError(); updateTimerDisplayAndControls();
            jumpToInput.max = (quizData && quizData.length > 0) ? quizData.length : 1; jumpToInput.value = ''; jumpLabel.textContent = "ƒê·∫øn c√¢u:";
            usageDetails.classList.add('hidden'); 
            selectSection.classList.add('hidden'); selectSection.style.display = 'none';
            resultsSection.classList.add('hidden'); resultsSection.style.display = 'none'; 
            quizSection.classList.remove('hidden'); quizSection.style.display = 'block'; 
            navControls.classList.remove('hidden'); reviewControls.classList.add('hidden');
            
            settingsBtn.disabled = false; 
            settingsBtn.style.opacity = ''; settingsBtn.style.cursor = '';

            quizTitleElement.textContent = currentQuizDisplayName; 
            quizTitleElement.classList.remove('hidden');
            displayQuestion(currentQuestionIndex);
        }

        function displayQuestion(index) {
             currentQuestionIndex = index;
             if (index < 0 || !quizData || index >= quizData.length || !quizData[index]) { console.error(`[Display Error] Invalid index ${index}. Quiz length: ${quizData?.length}`); showError(`L·ªói hi·ªÉn th·ªã c√¢u ${index + 1}.`); return; }
             const currentQuestion = quizData[index];
             questionText.textContent = currentQuestion.question || "[L·ªói: Thi·∫øu c√¢u h·ªèi]";
             answersContainer.innerHTML = ''; sourceDiv.textContent = ''; sourceDiv.classList.add('hidden'); sourceDiv.style.display = 'none';
             (currentQuestion.options || []).forEach((option, optionIndex) => { const btn = document.createElement('button'); btn.classList.add('answer-btn'); btn.textContent = option || "(Tr·ªëng)"; btn.dataset.index = optionIndex; answersContainer.appendChild(btn); });
             scoreText.textContent = `ƒêi·ªÉm: ${score}`;
             if (isReviewMode) {
                 if (reviewWrongOnly) { progressText.textContent = `C√¢u sai ${currentWrongAnswerReviewIndex + 1} / ${wrongAnswerIndices.length}`; jumpLabel.textContent = "ƒê·∫øn sai s·ªë:"; jumpToInput.max = wrongAnswerIndices.length || 1; jumpToInput.placeholder = wrongAnswerIndices.length > 0 ? (currentWrongAnswerReviewIndex + 1).toString() : '0'; }
                 else { progressText.textContent = `Xem l·∫°i: C√¢u ${index + 1} / ${quizData.length}`; jumpLabel.textContent = "ƒê·∫øn c√¢u:"; jumpToInput.max = quizData.length; jumpToInput.placeholder = (index + 1).toString(); }
             } else { progressText.textContent = `C√¢u ${index + 1} / ${quizData.length}`; jumpLabel.textContent = "ƒê·∫øn c√¢u:"; jumpToInput.max = quizData.length; jumpToInput.placeholder = (index + 1).toString(); }
             restoreAnswerState(index);
             navControls.classList.toggle('hidden', isReviewMode);
             reviewControls.classList.toggle('hidden', !isReviewMode);
             
             settingsBtn.disabled = isReviewMode; 
             settingsBtn.style.opacity = isReviewMode ? '0.5' : '';
             settingsBtn.style.cursor = isReviewMode ? 'not-allowed' : '';

             if(isReviewMode){ clearAutoAdvanceTimer(); timerBar.classList.remove('timer-active'); toggleFilterBtn.textContent = reviewWrongOnly ? "Xem t·∫•t c·∫£" : "Ch·ªâ xem sai"; toggleFilterBtn.classList.toggle('filter-active', reviewWrongOnly); toggleFilterBtn.disabled = wrongAnswerIndices.length === 0 && !reviewWrongOnly; }
             else { updateTimerDisplayAndControls(); }
             if (reviewWrongOnly) { prevBtn.disabled = (currentWrongAnswerReviewIndex <= 0); nextBtn.disabled = (currentWrongAnswerReviewIndex >= wrongAnswerIndices.length - 1); nextBtn.textContent = 'C√¢u sau'; }
             else { prevBtn.disabled = (index <= 0); const isLast = index === quizData.length - 1; const isAnswered = questionsAnswered[index]; nextBtn.textContent = (isLast && !isReviewMode) ? 'Ho√†n th√†nh' : 'C√¢u sau'; nextBtn.disabled = (!isReviewMode && !isAnswered) || (isReviewMode && isLast); }
             const settingsDialog = document.getElementById('settings-dialog'); if (settingsDialog) { settingsDialog.close(); }
        }

        function restoreAnswerState(questionIndex) {
            const userAnswerIndex = userAnswers[questionIndex]; const buttons = answersContainer.querySelectorAll('.answer-btn');
            const q = quizData[questionIndex]; if (!q) return; const correctIdx = q.correctAnswerIndex;
            buttons.forEach((b, idx) => { b.disabled = isReviewMode || (userAnswerIndex !== undefined); b.classList.remove('selected', 'correct', 'incorrect', 'reveal-correct');
                if (userAnswerIndex !== undefined) { const answerIdx = parseInt(b.dataset.index, 10); if (answerIdx === userAnswerIndex) { b.classList.add('selected'); b.classList.add(userAnswerIndex === correctIdx ? 'correct' : 'incorrect'); } else if (userAnswerIndex !== correctIdx && answerIdx === correctIdx) { b.classList.add('reveal-correct'); } } });
            if (userAnswerIndex !== undefined || isReviewMode) { sourceDiv.textContent = `Ngu·ªìn: ${q.source || 'N/A'}`; sourceDiv.classList.remove('hidden'); sourceDiv.style.display = 'block'; }
            else { sourceDiv.classList.add('hidden'); sourceDiv.style.display = 'none'; }
        }

        function handleAnswerSelection(selectedButton) {
             if (isReviewMode || questionsAnswered[currentQuestionIndex]) return; clearAutoAdvanceTimer();
             const selectedIndex = parseInt(selectedButton.dataset.index, 10); const currentQuestion = quizData[currentQuestionIndex]; if (!currentQuestion) return; const correctIndex = currentQuestion.correctAnswerIndex;
             userAnswers[currentQuestionIndex] = selectedIndex; questionsAnswered[currentQuestionIndex] = true;
             const allButtons = answersContainer.querySelectorAll('.answer-btn'); allButtons.forEach(b => b.disabled = true); selectedButton.classList.add('selected');
             let isCorrect = (selectedIndex === correctIndex); if (isCorrect) { score++; selectedButton.classList.add('correct'); } else { selectedButton.classList.add('incorrect'); if (allButtons[correctIndex]) { allButtons[correctIndex].classList.add('reveal-correct'); } }
             sourceDiv.textContent = `Ngu·ªìn: ${currentQuestion.source || 'N/A'}`; sourceDiv.classList.remove('hidden'); sourceDiv.style.display = 'block';
             scoreText.textContent = `ƒêi·ªÉm: ${score}`; nextBtn.disabled = false; 
             if (currentQuestionIndex === quizData.length - 1) { nextBtn.textContent = 'Ho√†n th√†nh'; }
             if (isCorrect && currentQuestionIndex < quizData.length - 1 && autoAdvanceDuration > 0) { timerBar.classList.add('timer-active'); autoAdvanceTimer = setTimeout(() => { autoAdvanceTimer = null; navigateNext(); }, autoAdvanceDuration); }
             saveState(); 
        }

        function showResults() {
            console.log("[Mode] Showing Results. Display Name:", currentQuizDisplayName);
            if (!isReviewMode) { if (typeof confetti === 'function') { confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 }, zIndex: 1050 }); } else { console.warn("[Effect] Confetti function not found."); } }
            isReviewMode = false; reviewWrongOnly = false; clearAutoAdvanceTimer();
            quizSection.classList.add('hidden'); quizSection.style.display = 'none'; resultsSection.classList.remove('hidden'); resultsSection.style.display = 'block';
            finalScoreText.textContent = `ƒêi·ªÉm cu·ªëi c√πng: ${score} / ${quizData.length}`; 
            quizTitleElement.textContent = currentQuizDisplayName; 
            quizTitleElement.classList.remove('hidden');
            settingsBtn.disabled = true; 
            settingsBtn.style.opacity = '0.5'; settingsBtn.style.cursor = 'not-allowed';
            saveState();
        }

        function restartQuiz(wasShuffled = false) {
             if (!quizData || quizData.length === 0) { showSelectScreen(); return; } console.log(`[Action] Restarting quiz: ${currentQuizDisplayName}`);
             score = 0; userAnswers = {}; questionsAnswered = {}; currentQuestionIndex = 0; isReviewMode = false; reviewWrongOnly = false; wrongAnswerIndices = []; currentWrongAnswerReviewIndex = 0;
             if (!wasShuffled) { quizData = [...originalQuizData]; if (shuffleCheckbox.checked) { shuffleArray(quizData); } }
             startQuiz(true); saveState();
         }

        function startReviewMode() {
             if (!quizData || quizData.length === 0 || Object.keys(userAnswers).length === 0) { alert("Ch∆∞a c√≥ g√¨ ƒë·ªÉ xem l·∫°i!"); return; }
             console.log("[Mode] Entering Review"); wrongAnswerIndices = [];
             quizData.forEach((q, index) => { const userAnswer = userAnswers[index]; if (userAnswer !== undefined && userAnswer !== q.correctAnswerIndex) { wrongAnswerIndices.push(index); } });
             isReviewMode = true; reviewWrongOnly = false; currentQuestionIndex = 0; currentWrongAnswerReviewIndex = 0;
             clearAutoAdvanceTimer(); updateTimerDisplayAndControls();
             resultsSection.classList.add('hidden'); resultsSection.style.display = 'none'; quizSection.classList.remove('hidden'); quizSection.style.display = 'block'; 
             displayQuestion(currentQuestionIndex); saveState();
        }
        function exitReviewMode() { console.log("[Mode] Exiting Review"); isReviewMode = false; reviewWrongOnly = false; showResults(); }
        function toggleReviewFilter() {
             if (!isReviewMode) return; reviewWrongOnly = !reviewWrongOnly;
             if (reviewWrongOnly) { if (wrongAnswerIndices.length === 0) { alert("Ch√∫c m·ª´ng! T·∫•t c·∫£ ƒë·ªÅu ƒë√∫ng."); reviewWrongOnly = false; toggleFilterBtn.classList.remove('filter-active'); return; } currentWrongAnswerReviewIndex = 0; currentQuestionIndex = wrongAnswerIndices[currentWrongAnswerReviewIndex]; }
             displayQuestion(currentQuestionIndex); saveState();
         }

        function showError(message) { console.error("[UI Error]", message); errorMessage.textContent = message; errorMessage.classList.remove('hidden'); }
        function hideError() { errorMessage.textContent = ''; errorMessage.classList.add('hidden'); }

        function showSelectScreen(preventClear = false) {
             console.log("[UI] Show Select Screen" + (preventClear ? " (no state clear)" : ""));
             if (!preventClear) { clearState(); loadedQuizzes = {}; }
             originalQuizData = []; quizData = []; currentQuizDisplayName = ""; score = 0; userAnswers = {}; questionsAnswered = {}; currentQuestionIndex = 0; isReviewMode = false; reviewWrongOnly = false; wrongAnswerIndices = []; currentWrongAnswerReviewIndex = 0;
             clearAutoAdvanceTimer(); hideError();
             quizSection.classList.add('hidden'); quizSection.style.display = 'none'; 
             resultsSection.classList.add('hidden'); resultsSection.style.display = 'none';
             usageDetails.classList.remove('hidden');
             quizTitleElement.textContent = ''; quizTitleElement.classList.add('hidden');
             selectSection.classList.remove('hidden'); selectSection.style.display = 'block'; 
             shuffleCheckbox.disabled = false;

             if (quizFileListContainer) {
                 quizFileListContainer.innerHTML = ''; 
                 const select = document.createElement('select'); 
                 select.id = 'quiz-file-select'; 
                 select.innerHTML = '<option value="">ƒêang t·∫£i danh s√°ch...</option>'; 
                 select.disabled = true;
                 quizFileListContainer.appendChild(select); 
                 quizFileSelect = select; 
             } else {
                 console.error("[UI Error] quizFileListContainer not found in showSelectScreen.");
             }

             statusMessage.textContent = ""; errorMessage.textContent = ''; errorMessage.classList.add('hidden');
             
             settingsBtn.disabled = true; 
             settingsBtn.style.opacity = '0.5'; settingsBtn.style.cursor = 'not-allowed';


             const cachedManifest = sessionStorage.getItem('quizManifest');
             if (cachedManifest) { 
                 try { 
                     const manifestData = JSON.parse(cachedManifest); 
                     displayQuizOptions(manifestData); 
                     attachQuizSelectListener(); 
                 } catch (e) { 
                     loadQuizManifest(); 
                 } 
             } else { 
                 loadQuizManifest(); 
             }
         }

        document.addEventListener('DOMContentLoaded', () => {
             console.log("[Init] DOM Loaded.");
             applyInitialTheme();
             
             const restoredState = loadState(); 
             if (restoredState) {
                console.log("[Init] Restored state found, attempting to resume.");
                const resumeQuizName = restoredState.quizDisplayName || "b√†i l√†m tr∆∞·ªõc"; 
                const resumeQuestionNum = (restoredState.currentQuestionIndex || 0) + 1; 
                const resumeTotalQuestions = restoredState.quizData?.length || "?"; 
                let resumeMessage = `B·∫°n c√≥ m·ªôt b√†i l√†m d·ªü dang cho "${resumeQuizName}"`;
                if (restoredState.view === 'quiz') { resumeMessage += ` (ƒëang ·ªü c√¢u ${resumeQuestionNum}/${resumeTotalQuestions}). B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?`; }
                else if (restoredState.view === 'results') { resumeMessage += ` (ƒëang ·ªü m√†n h√¨nh k·∫øt qu·∫£). B·∫°n c√≥ mu·ªën xem l·∫°i kh√¥ng?`; }
                else { resumeMessage += `. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?`; }
                showResumeModal(resumeMessage);
             } else {
                 console.log("[Init] No valid state, starting fresh.");
                 updateTimerDisplayAndControls(); 
                 showSelectScreen(true); 
                 if (usageDetails.hasAttribute('open')) { usageDetails.open = true; usageDetails.classList.remove('hidden'); }
                 else { usageDetails.classList.add('hidden'); }
             }
         });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const questionContainer = document.getElementById('question-container'); if (!questionContainer) return;
            const leftIndicator = document.createElement('div'); leftIndicator.className = 'swipe-indicator swipe-left'; leftIndicator.innerHTML = '‚Äπ';
            const rightIndicator = document.createElement('div'); rightIndicator.className = 'swipe-indicator swipe-right'; rightIndicator.innerHTML = '‚Ä∫';
            questionContainer.appendChild(leftIndicator); questionContainer.appendChild(rightIndicator);
            let touchStartX = 0; let touchEndX = 0; const minSwipeDistance = 75;
            questionContainer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            questionContainer.addEventListener('touchmove', (e) => { const currentX = e.changedTouches[0].screenX; const diffX = currentX - touchStartX; leftIndicator.classList.remove('swipe-active'); rightIndicator.classList.remove('swipe-active'); if (diffX > 30) { leftIndicator.classList.add('swipe-active'); } else if (diffX < -30) { rightIndicator.classList.add('swipe-active'); } }, { passive: true });
            questionContainer.addEventListener('touchend', (e) => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); setTimeout(() => { leftIndicator.classList.remove('swipe-active'); rightIndicator.classList.remove('swipe-active'); }, 300); }, { passive: true });
            function handleSwipe() { const diffX = touchEndX - touchStartX; if (Math.abs(diffX) < minSwipeDistance) return; if (diffX > 0) { const prevButton = document.getElementById('prev-btn'); if (prevButton && !prevButton.disabled) { navigatePrevious(); } } else { const nextButton = document.getElementById('next-btn'); if (nextButton && !nextButton.disabled) { navigateNext(); } } }
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => { console.log('[Service Worker] Registration successful:', registration); })
                    .catch(error => { console.error('[Service Worker] Registration failed:', error); });
            });
        }
    </script>
</body>
</html>